# Element Plus + 原生 DOM 动态主题切换实现总结

## 一、核心原理

### 1.1 CSS 变量（CSS Custom Properties）

现代浏览器支持 **CSS 变量**，这是实现动态主题的基础。

```css
:root {
  --el-color-primary: #409eff; /* 定义变量 */
}

.el-button--primary {
  background-color: var(--el-color-primary); /* 使用变量 */
}
```

**关键点：**

- CSS 变量定义在 `:root`（即 `<html>` 元素）上，全局可用
- 通过 JavaScript 修改 `:root` 上的变量值，所有使用该变量的元素会**立即更新**
- 这是一种"牵一发而动全身"的机制

### 1.2 Element Plus 的主题系统

Element Plus 内部使用了一套 CSS 变量来定义主题色：

| 变量名                       | 用途                       |
| ---------------------------- | -------------------------- |
| `--el-color-primary`         | 主色（按钮、链接等）       |
| `--el-color-primary-rgb`     | RGB 格式（用于透明度计算） |
| `--el-color-primary-light-3` | 浅色（hover 状态）         |
| `--el-color-primary-light-5` | 更浅                       |
| `--el-color-primary-light-7` | 再浅                       |
| `--el-color-primary-light-8` | 极浅（disabled）           |
| `--el-color-primary-light-9` | 最浅（背景）               |
| `--el-color-primary-dark-2`  | 深色（active 状态）        |
| `--el-menu-active-color`     | 菜单激活色                 |

**原理流程：**

```
用户选择颜色 (#ff8c00)
        ↓
JavaScript 计算颜色变体
        ↓
设置 CSS 变量到 :root
        ↓
浏览器自动重绘使用变量的元素
        ↓
界面颜色更新
```

---

## 二、实现步骤

### 2.1 颜色算法：生成浅色/深色变体

Element Plus 需要一系列颜色变体。我们通过**颜色混合算法**生成：

```javascript
// src/utils/theme.js

// HEX 转 RGB
function hexToRgb(hex) {
  hex = hex.replace("#", "");
  return {
    r: parseInt(hex.substring(0, 2), 16),
    g: parseInt(hex.substring(2, 4), 16),
    b: parseInt(hex.substring(4, 6), 16),
  };
}

// 与白色混合 → 生成浅色
function mixWhite(hex, level) {
  const { r, g, b } = hexToRgb(hex);
  const ratio = level / 10; // level=3 表示 30% 白色
  return rgbToHex(
    r + (255 - r) * ratio, // 向 255 靠近
    g + (255 - g) * ratio,
    b + (255 - b) * ratio
  );
}

// 与黑色混合 → 生成深色
function mixBlack(hex, level) {
  const { r, g, b } = hexToRgb(hex);
  const ratio = level / 10;
  return rgbToHex(
    r * (1 - ratio), // 向 0 靠近
    g * (1 - ratio),
    b * (1 - ratio)
  );
}
```

**示例：** 主色 `#409EFF` 生成的变体：

| 变体    | 颜色值  |
| ------- | ------- |
| primary | #409EFF |
| light-3 | #79bbff |
| light-5 | #a0cfff |
| light-9 | #ecf5ff |
| dark-2  | #337ecc |

---

### 2.2 应用主题：修改 CSS 变量

```javascript
// src/utils/theme.js

export function applyTheme(primary) {
  const colors = generateColors(primary);
  const root = document.documentElement; // 获取 <html> 元素

  // 设置 Element Plus CSS 变量
  root.style.setProperty("--el-color-primary", colors.primary);
  root.style.setProperty("--el-color-primary-rgb", colors["primary-rgb"]);
  root.style.setProperty(
    "--el-color-primary-light-3",
    colors["primary-light-3"]
  );
  // ... 更多变量

  // 设置菜单相关颜色
  root.style.setProperty("--el-menu-active-color", colors.primary);
}
```

**核心 API：**

```javascript
document.documentElement.style.setProperty("--变量名", "值");
```

---

### 2.3 状态管理：Vuex 存储主题色

```javascript
// src/stores/modules/theme.js

import { applyTheme } from "@/utils/theme";

export default {
  namespaced: true,
  state: () => ({
    theme: getItem(MAIN_COLOR) || "#409EFF", // 从 localStorage 读取
  }),
  mutations: {
    setTheme(state, newColor) {
      state.theme = newColor;
      setItem(MAIN_COLOR, newColor); // 持久化
      applyTheme(newColor); // 立即应用
    },
  },
};
```

**数据流：**

```
用户选择颜色
    ↓
store.commit('theme/setTheme', color)
    ↓
├── 更新 state.theme
├── 保存到 localStorage
└── 调用 applyTheme(color)
```

---

### 2.4 初始化：页面加载时恢复主题

```vue
<!-- src/App.vue -->
<script setup>
import { applyTheme } from "@/utils/theme";
import { useStore } from "vuex";

const store = useStore();

// 页面加载时，应用保存的主题色
applyTheme(store.getters.theme);
</script>
```

---

### 2.5 原生 DOM 换肤：Vue 响应式 + 动态样式

对于不使用 CSS 变量的原生组件（如侧边栏），我们使用 **Vue 的响应式机制**：

```js
<!-- src/layout/components/sidebar/SidebarIndex.vue -->
<template>
  <div class="sidebar-container" :style="sidebarStyle">
    <!-- ... -->
  </div>
</template>

<script setup>
import { computed } from "vue";
import { useStore } from "vuex";

const store = useStore();

// 响应式获取主题色
const sidebarBgColor = computed(() => store.getters.theme || "#409EFF");

// 动态样式对象
const sidebarStyle = computed(() => ({
  backgroundColor: sidebarBgColor.value,
  color: "#ffffff",
}));
</script>
```

**原理：**

- `computed` 会追踪 `store.getters.theme` 的变化
- 当主题色改变时，`sidebarStyle` 自动重新计算
- Vue 自动更新 DOM 的 `style` 属性

---

## 三、完整数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户操作                                  │
│                    点击颜色选择器                                │
└─────────────────────┬───────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────────┐
│                   ColorChange.vue                               │
│   store.commit('theme/setTheme', myColor.value)                │
└─────────────────────┬───────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────────┐
│                   Vuex (theme.js)                               │
│   ├── state.theme = newColor                                   │
│   ├── setItem(MAIN_COLOR, newColor)  → localStorage            │
│   └── applyTheme(newColor)           → CSS 变量                │
└─────────────────────┬───────────────────────────────────────────┘
                      ↓
        ┌─────────────┴─────────────┐
        ↓                           ↓
┌───────────────────┐     ┌───────────────────────────────┐
│  CSS 变量更新      │     │  Vue 响应式更新                │
│  :root {          │     │  computed(() => theme)        │
│    --el-color-... │     │        ↓                      │
│  }                │     │  sidebarStyle 重新计算         │
└────────┬──────────┘     └──────────────┬────────────────┘
         ↓                               ↓
┌───────────────────┐     ┌───────────────────────────────┐
│  Element Plus     │     │  原生 DOM                      │
│  按钮、链接等      │     │  侧边栏、自定义组件            │
│  自动使用新颜色    │     │  通过 :style 绑定更新         │
└───────────────────┘     └───────────────────────────────┘
```

---

## 四、关键文件清单

| 文件                                                    | 作用                    |
| ------------------------------------------------------- | ----------------------- |
| `src/utils/theme.js`                                    | 颜色算法 + CSS 变量设置 |
| `src/stores/modules/theme.js`                           | Vuex 状态管理           |
| `src/App.vue`                                           | 初始化时应用主题        |
| `src/components/themeSelect/components/ColorChange.vue` | 颜色选择器弹窗          |
| `src/layout/components/sidebar/SidebarIndex.vue`        | 侧边栏容器（动态背景）  |
| `src/layout/components/sidebar/SidebarMenu.vue`         | 侧边栏菜单（动态颜色）  |

---

## 五、总结

| 目标                  | 技术方案                            |
| --------------------- | ----------------------------------- |
| Element Plus 组件换肤 | 修改 `:root` 上的 CSS 变量          |
| 原生 DOM 换肤         | Vue `computed` + `:style` 绑定      |
| 颜色变体生成          | 颜色混合算法（与白色/黑色混合）     |
| 状态持久化            | Vuex + localStorage                 |
| 页面刷新后保持        | App.vue 初始化时调用 `applyTheme()` |

**核心思想：**

> 将主题色抽象为一个全局状态，通过 CSS 变量和 Vue 响应式机制，实现"改一处，变全局"的效果。
